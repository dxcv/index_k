import re
from utils.database import config as cfg, io
from utils.etlkit.core.base import Stream, Confluence
from utils.etlkit.core import transform
from utils.etlkit.reader.mysqlreader import MysqlInput


ENGINE_RD = cfg.load_engine()["2Gb"]


class StreamsMain:
    TYPE_NAME = {
        '农业': '农、林、牧、渔业',
        '林业': '农、林、牧、渔业',
        '畜牧业': '农、林、牧、渔业',
        '渔业': '农、林、牧、渔业',
        '农、林、牧、渔服务业': '农、林、牧、渔业',
        '煤炭开采和洗选业': '采矿业',
        '石油和天然气开采业': '采矿业',
        '黑色金属矿采选业': '采矿业',
        '有色金属矿采选业': '采矿业',
        '非金属矿采选业': '采矿业',
        '开采辅助活动': '采矿业',
        '其他采矿业': '采矿业',
        '农副食品加工业': '制造业',
        '食品制造业': '制造业',
        '酒、饮料和精制茶制造业': '制造业',
        '烟草制品业': '制造业',
        '纺织业': '制造业',
        '纺织服装、服饰业': '制造业',
        '皮革、毛皮、羽毛及其制品和制鞋业': '制造业',
        '木材加工和木、竹、藤、棕、草制品业': '制造业',
        '木材加工及木、竹、藤、棕、草制品业': '制造业',
        '家具制造业': '制造业',
        '造纸及纸制品业': '制造业',
        '造纸和纸制品业': '制造业',
        '印刷和记录媒介复制业': '制造业',
        '文教、工美、体育和娱乐用品制造业': '制造业',
        '石油加工、炼焦和核燃料加工业': '制造业',
        '石油加工、炼焦及核燃料加工业': '制造业',
        '化学原料和化学制品制造业': '制造业',
        '化学原料及化学制品制造业': '制造业',
        '医药制造业': '制造业',
        '化学纤维制造业': '制造业',
        '橡胶和塑料制品业': '制造业',
        '非金属矿物制品业': '制造业',
        '黑色金属冶炼和压延加工业': '制造业',
        '黑色金属冶炼及压延加工业': '制造业',
        '电信、广播电视和卫星传输传输服务': '信息传输、软件和信息技术服务业',
        '有色金属冶炼和压延加工业': '制造业',
        '有色金属冶炼及压延加工业': '制造业',
        '金属制品业': '制造业',
        '通用设备制造业': '制造业',
        '专用设备制造业': '制造业',
        '汽车制造业': '制造业',
        '铁路、船舶、航空航天和其他运输设备制造业': '制造业',
        '铁路、船舶、航空航天和其它运输设备制造业': '制造业',
        '电气机械和器材制造业': '制造业',
        '电气机械及器材制造业': '制造业',
        '计算机、通信和其他电子设备制造业': '制造业',
        '仪器仪表制造业': '制造业',
        '其他制造业': '制造业',
        '废弃资源综合利用业': '制造业',
        '金属制品、机械和设备修理业': '制造业',
        '电力、热力生产和供应业': '电力、热力、燃气及水生产和供应业',
        '燃气生产和供应业': '电力、热力、燃气及水生产和供应业',
        '水的生产和供应业': '电力、热力、燃气及水生产和供应业',
        '房屋建筑业': '建筑业',
        '土木工程建筑业': '建筑业',
        '建筑安装业': '建筑业',
        '建筑装饰和其他建筑业': '建筑业',
        '批发业': '批发和零售业',
        '零售业': '批发和零售业',
        '铁路运输业': '交通运输、仓储和邮政业',
        '道路运输业': '交通运输、仓储和邮政业',
        '水上运输业': '交通运输、仓储和邮政业',
        '航空运输业': '交通运输、仓储和邮政业',
        '管道运输业': '交通运输、仓储和邮政业',
        '装卸搬运和运输代理业': '交通运输、仓储和邮政业',
        '装卸搬运和其他运输代理业': '交通运输、仓储和邮政业',
        '仓储业': '交通运输、仓储和邮政业',
        '邮政业': '交通运输、仓储和邮政业',
        '住宿业': '住宿和餐饮业',
        '餐饮业': '住宿和餐饮业',
        '电信、广播电视和卫星传输服务': '信息传输、软件和信息技术服务业',
        '电信、广播电视及卫星传输服务': '信息传输、软件和信息技术服务业',
        '互联网和相关服务': '信息传输、软件和信息技术服务业',
        '软件和信息技术服务业': '信息传输、软件和信息技术服务业',
        '货币金融服务': '金融业',
        '资本市场服务': '金融业',
        '保险业': '金融业',
        '其他金融业': '金融业',
        '房地产业': '房地产业',
        '租赁业': '租赁和商务服务业',
        '商务服务业': '租赁和商务服务业',
        '研究和试验发展': '科学研究和技术服务业',
        '专业技术服务业': '科学研究和技术服务业',
        '科技推广和应用服务业': '科学研究和技术服务业',
        '水利管理业': '水利、环境和公共设施管理业',
        '生态保护和环境治理业': '水利、环境和公共设施管理业',
        '公共设施管理业': '水利、环境和公共设施管理业',
        '居民服务业': '居民服务、修理和其他服务业',
        '机动车、电子产品和日用产品修理业': '居民服务、修理和其他服务业',
        '其他服务业': '居民服务、修理和其他服务业',
        '教育': '教育',
        '卫生': '卫生和社会工作',
        '社会工作': '卫生和社会工作',
        '新闻和出版业': '文化、体育和娱乐业',
        '广播、电视、电影和影视录音制作业': '文化、体育和娱乐业',
        '文化艺术业': '文化、体育和娱乐业',
        '体育': '文化、体育和娱乐业',
        '娱乐业': '文化、体育和娱乐业',
        '综合': '综合'
    }

    TYPE_CODE = {
        '农业': 'A',
        '林业': 'A',
        '畜牧业': 'A',
        '渔业': 'A',
        '农、林、牧、渔服务业': 'A',
        '煤炭开采和洗选业': 'B',
        '石油和天然气开采业': 'B',
        '黑色金属矿采选业': 'B',
        '有色金属矿采选业': 'B',
        '非金属矿采选业': 'B',
        '开采辅助活动': 'B',
        '其他采矿业': 'B',
        '农副食品加工业': 'C',
        '食品制造业': 'C',
        '酒、饮料和精制茶制造业': 'C',
        '烟草制品业': 'C',
        '纺织业': 'C',
        '纺织服装、服饰业': 'C',
        '皮革、毛皮、羽毛及其制品和制鞋业': 'C',
        '木材加工和木、竹、藤、棕、草制品业': 'C',
        '木材加工及木、竹、藤、棕、草制品业': 'C',
        '家具制造业': 'C',
        '造纸及纸制品业': 'C',
        '造纸和纸制品业': 'C',
        '印刷和记录媒介复制业': 'C',
        '文教、工美、体育和娱乐用品制造业': 'C',
        '石油加工、炼焦和核燃料加工业': 'C',
        '石油加工、炼焦及核燃料加工业': 'C',
        '化学原料和化学制品制造业': 'C',
        '化学原料及化学制品制造业': 'C',
        '医药制造业': 'C',
        '化学纤维制造业': 'C',
        '橡胶和塑料制品业': 'C',
        '非金属矿物制品业': 'C',
        '黑色金属冶炼和压延加工业': 'C',
        '黑色金属冶炼及压延加工业': 'C',
        '电信、广播电视和卫星传输传输服务': 'I',
        '有色金属冶炼和压延加工业': 'C',
        '有色金属冶炼及压延加工业': 'C',
        '金属制品业': 'C',
        '通用设备制造业': 'C',
        '专用设备制造业': 'C',
        '汽车制造业': 'C',
        '铁路、船舶、航空航天和其他运输设备制造业': 'C',
        '铁路、船舶、航空航天和其它运输设备制造业': 'C',
        '电气机械和器材制造业': 'C',
        '电气机械及器材制造业': 'C',
        '计算机、通信和其他电子设备制造业': 'C',
        '仪器仪表制造业': 'C',
        '其他制造业': 'C',
        '废弃资源综合利用业': 'C',
        '金属制品、机械和设备修理业': 'C',
        '电力、热力生产和供应业': 'D',
        '燃气生产和供应业': 'D',
        '水的生产和供应业': 'D',
        '房屋建筑业': 'E',
        '土木工程建筑业': 'E',
        '建筑安装业': 'E',
        '建筑装饰和其他建筑业': 'E',
        '批发业': 'F',
        '零售业': 'F',
        '铁路运输业': 'G',
        '道路运输业': 'G',
        '水上运输业': 'G',
        '航空运输业': 'G',
        '管道运输业': 'G',
        '装卸搬运和运输代理业': 'G',
        '装卸搬运和其他运输代理业': 'G',
        '仓储业': 'G',
        '邮政业': 'G',
        '住宿业': 'H',
        '餐饮业': 'H',
        '电信、广播电视和卫星传输服务': 'I',
        '电信、广播电视及卫星传输服务': 'I',
        '互联网和相关服务': 'I',
        '软件和信息技术服务业': 'I',
        '货币金融服务': 'J',
        '资本市场服务': 'J',
        '保险业': 'J',
        '其他金融业': 'J',
        '房地产业': 'K',
        '租赁业': 'L',
        '商务服务业': 'L',
        '研究和试验发展': 'M',
        '专业技术服务业': 'M',
        '科技推广和应用服务业': 'M',
        '水利管理业': 'N',
        '生态保护和环境治理业': 'N',
        '公共设施管理业': 'N',
        '居民服务业': 'O',
        '机动车、电子产品和日用产品修理业': 'O',
        '其他服务业': 'O',
        '教育': 'P',
        '卫生': 'Q',
        '社会工作': 'Q',
        '新闻和出版业': 'R',
        '广播、电视、电影和影视录音制作业': 'R',
        '文化艺术业': 'R',
        '体育': 'R',
        '娱乐业': 'R',
        '综合': 'S'
    }

    STYPE_CODE = {
        '农业': '01',
        '林业': '02',
        '畜牧业': '03',
        '渔业': '04',
        '农、林、牧、渔服务业': '05',
        '煤炭开采和洗选业': '06',
        '石油和天然气开采业': '07',
        '黑色金属矿采选业': '08',
        '有色金属矿采选业': '09',
        '非金属矿采选业': '10',
        '开采辅助活动': '11',
        '其他采矿业': '12',
        '农副食品加工业': '13',
        '食品制造业': '14',
        '酒、饮料和精制茶制造业': '15',
        '烟草制品业': '16',
        '纺织业': '17',
        '纺织服装、服饰业': '18',
        '皮革、毛皮、羽毛及其制品和制鞋业': '19',
        '木材加工和木、竹、藤、棕、草制品业': '20',
        '木材加工及木、竹、藤、棕、草制品业': '20',
        '家具制造业': '21',
        '造纸及纸制品业': '22',
        '造纸和纸制品业': '22',
        '印刷和记录媒介复制业': '23',
        '文教、工美、体育和娱乐用品制造业': '24',
        '石油加工、炼焦和核燃料加工业': '25',
        '石油加工、炼焦及核燃料加工业': '25',
        '化学原料和化学制品制造业': '26',
        '化学原料及化学制品制造业': '26',
        '医药制造业': '27',
        '化学纤维制造业': '28',
        '橡胶和塑料制品业': '29',
        '非金属矿物制品业': '30',
        '黑色金属冶炼和压延加工业': '31',
        '黑色金属冶炼及压延加工业': '31',
        '电信、广播电视和卫星传输传输服务': '63',
        '有色金属冶炼和压延加工业': '32',
        '有色金属冶炼及压延加工业': '32',
        '金属制品业': '33',
        '通用设备制造业': '34',
        '专用设备制造业': '35',
        '汽车制造业': '36',
        '铁路、船舶、航空航天和其他运输设备制造业': '37',
        '铁路、船舶、航空航天和其它运输设备制造业': '37',
        '电气机械和器材制造业': '38',
        '电气机械及器材制造业': '38',
        '计算机、通信和其他电子设备制造业': '39',
        '仪器仪表制造业': '40',
        '其他制造业': '41',
        '废弃资源综合利用业': '42',
        '金属制品、机械和设备修理业': '43',
        '电力、热力生产和供应业': '44',
        '燃气生产和供应业': '45',
        '水的生产和供应业': '46',
        '房屋建筑业': '47',
        '土木工程建筑业': '48',
        '建筑安装业': '49',
        '建筑装饰和其他建筑业': '50',
        '批发业': '51',
        '零售业': '52',
        '铁路运输业': '53',
        '道路运输业': '54',
        '水上运输业': '55',
        '航空运输业': '56',
        '管道运输业': '57',
        '装卸搬运和运输代理业': '58',
        '装卸搬运和其他运输代理业': '58',
        '仓储业': '59',
        '邮政业': '60',
        '住宿业': '61',
        '餐饮业': '62',
        '电信、广播电视和卫星传输服务': '63',
        '电信、广播电视及卫星传输服务': '63',
        '互联网和相关服务': '64',
        '软件和信息技术服务业': '65',
        '货币金融服务': '66',
        '资本市场服务': '67',
        '保险业': '68',
        '其他金融业': '69',
        '房地产业': '70',
        '租赁业': '71',
        '商务服务业': '72',
        '研究和试验发展': '73',
        '专业技术服务业': '74',
        '科技推广和应用服务业': '75',
        '水利管理业': '76',
        '生态保护和环境治理业': '77',
        '公共设施管理业': '78',
        '居民服务业': '79',
        '机动车、电子产品和日用产品修理业': '80',
        '其他服务业': '81',
        '教育': '82',
        '卫生': '83',
        '社会工作': '84',
        '新闻和出版业': '85',
        '广播、电视、电影和影视录音制作业': '86',
        '文化艺术业': '87',
        '体育': '88',
        '娱乐业': '89',
        '综合': '90'
    }

    @classmethod
    def add_stock_suffix(cls, stock_id):
        head = stock_id[:3]
        if head in {"600", "601", "603", "900"}:
            suffix = ".SH"
        elif head in {"000", "001", "002", "200", "300"}:
            suffix = ".SZ"
        return stock_id + suffix

    @classmethod
    def stream_000001(cls):
        """
            清洗stock_info_010001 CSRC分类;

        """

        sql = "SELECT stock_id,type_csrc FROM crawl_finance.stock_info_010001"

        inp = MysqlInput(ENGINE_RD, sql)

        vm = transform.ValueMap({
            "type_csrc": lambda x: re.sub("\s", "", x.split(",")[1]),
            "category_code": (lambda x: cls.TYPE_CODE.get(x), "type_csrc"),
            "category_name": (lambda x: cls.TYPE_NAME.get(x), "type_csrc"),
            "type_code": (lambda x: cls.STYPE_CODE.get(x), "type_csrc"),
            "stock_id": lambda x: str(cls.add_stock_suffix(x)) + ".SH"
        })

        sk = transform.MapSelectKeys({
            "stock_id": "stock_id",
            "category_name": "category_name",
            "category_code": "category_code",
            "type_code": "type_code",
            "type_csrc": "type_name"
        })

        dn = transform.Dropna(subset=None, axis=0, how='any')

        s = Stream(inp, transform=[vm, sk, dn])
        return s

    @classmethod
    def conluf(cls):
        streams = [cls.stream_000001(), ]
        c = Confluence(*streams)
        return c


def main():

    c = StreamsMain.conluf()
    io.to_sql("base_finance.stock_type_csrc", ENGINE_RD, c.dataframe)


if __name__ == "__main__":
    main()
